<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team 2's Project</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <script>
        function clearHistory() {
            const historyDiv = document.getElementById('searchHistory');
            historyDiv.innerHTML = '';
        }

        async function fetchArtistData() {
            const artistName = document.getElementById('artistSearch').value;
            const apiUrl = `http://127.0.0.1:8000/?artist_name=${encodeURIComponent(artistName)}`;

            try {
                let response = await fetch(apiUrl);
                let data = await response.json();
                const artist = data.message;

                document.getElementById('artistName').innerText = artist.name;
                document.getElementById('artistFollowers').innerText = `Followers: ${artist.followers.total}`;
                document.getElementById('artistGenres').innerText = `Genres: ${artist.genres.join(", ")}`;
                document.getElementById('artistPopularity').innerText = `Popularity: ${artist.popularity}`;
                document.getElementById('artistSpotifyLink').href = artist.external_urls.spotify;
                document.getElementById('artistImage').src = artist.images[0].url;

                addToHistory(artist);

                // Fetch the top 3 tracks for the artist
                fetchTopTracks(artistName);

            } catch (error) {
                console.error("There was an issue fetching the artist data. DM me to start the api again it's probably just offline. -K", error);
            }
        }

        async function fetchTopTracks(artistName) {
            const apiUrl = `http://127.0.0.1:8000/top-tracks?artist_name=${encodeURIComponent(artistName)}`;

            try {
                let response = await fetch(apiUrl);
                let data = await response.json();
                const topTracks = data.top_tracks;

                const tracksDiv = document.getElementById('topTracks');
                tracksDiv.innerHTML = ''; 

                topTracks.forEach(track => {
                    const trackLink = document.createElement('a');
                    trackLink.href = track.external_urls.spotify;
                    trackLink.target = "_blank";
                    trackLink.innerText = track.name;
                    const listItem = document.createElement('li');
                    listItem.appendChild(trackLink);
                    tracksDiv.appendChild(listItem);
                });

            } catch (error) {
                console.error("There was an issue fetching the top tracks. DM me it's probably an API issue again -K", error);
            }
        }
//add to the history on the left
        function addToHistory(artist) {
            const historyDiv = document.getElementById('searchHistory');
            const artistLink = document.createElement('a');
            artistLink.href = artist.external_urls.spotify;
            artistLink.target = "_blank";
            artistLink.innerText = artist.name;
            const listItem = document.createElement('li');
            listItem.appendChild(artistLink);
            historyDiv.appendChild(listItem);
        }

        function handleSearch(event) {
            event.preventDefault();
            fetchArtistData();
        }
    </script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Team 2's Project: Spotifiers</a>
        <form class="form-inline my-2 my-lg-0 ml-auto" onsubmit="handleSearch(event)">
            <input class="form-control mr-sm-2" type="search" id="artistSearch" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
        </form>
    </nav>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-3">
                <h5>Search History:</h5>
                <button onclick="clearHistory()" class="btn btn-outline-danger btn-sm mb-2">Clear History</button>
                <ul id="searchHistory" class="list-unstyled"></ul>
            </div>
            <div class="col-md-9">
                <h2 id="artistName"></h2>
                <img id="artistImage" src="" alt="Artist Image" class="img-thumbnail mb-3">
                <p id="artistFollowers"></p>
                <p id="artistGenres"></p>
                <p id="artistPopularity"></p>
                <a id="artistSpotifyLink" href="" target="_blank">Open on Spotify</a>
                <h5 class="mt-4">Top 3 Tracks:</h5>
                <ul id="topTracks" class="list-unstyled"></ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
